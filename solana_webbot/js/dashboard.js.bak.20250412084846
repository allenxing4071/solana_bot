/**
 * Solana MEVæœºå™¨äºº - ä»ªè¡¨ç›˜é¡µé¢JavaScript
 * å®ç°å¤„ç†APIæ•°æ®ã€æ˜¾ç¤ºå›¾è¡¨å’Œäº¤æ˜“åˆ—è¡¨åŠŸèƒ½
 */

// DOMå…ƒç´ ç¼“å­˜
const elements = {
    cpuUsage: document.getElementById('cpuUsage'),
    cpuBar: document.getElementById('cpuBar'),
    memoryUsage: document.getElementById('memoryUsage'),
    memoryBar: document.getElementById('memoryBar'),
    uptime: document.getElementById('uptime'),
    totalProfit: document.getElementById('totalProfit'),
    monitoredTokens: document.getElementById('monitoredTokens'),
    activePools: document.getElementById('activePools'),
    executedTrades: document.getElementById('executedTrades'),
    tradesTableBody: document.getElementById('tradesTableBody'),
    tokensTableBody: document.getElementById('tokensTableBody'),
    logContainer: document.getElementById('logContainer'),
    lastUpdated: document.getElementById('lastUpdated'),
    refreshData: document.getElementById('refreshData'),
    tokenDiscoveryChart: document.getElementById('tokenDiscoveryChart'),
    profitTrendChart: document.getElementById('profitTrendChart'),
    startBtn: document.getElementById('startBtn'),
    stopBtn: document.getElementById('stopBtn'),
    statusIndicator: document.getElementById('statusIndicator'),
    statusText: document.getElementById('statusText'),
    themeToggleBtn: document.getElementById('themeToggleBtn')
};

// å…¨å±€å˜é‡
const charts = {
    tokenDiscoveryChart: null,
    profitTrendChart: null
};

let systemData = {
    status: 'stopped',
    cpu: 0,
    memory: 0,
    uptime: 0,
    profit: 0,
    monitoredTokens: 0,
    activePools: 0,
    executedTrades: 0,
    tokenDiscoveryTrend: [],  // ä»£å¸å‘ç°è¶‹åŠ¿
    profitTrend: [],          // åˆ©æ¶¦è¶‹åŠ¿
    isRealData: true          // æ˜¯å¦çœŸå®æ•°æ®
};

// é¢œè‰²ä¸»é¢˜
const themes = {
    dark: {
        backgroundColor: '#1e2130',
        textColor: '#e1e1e6',
        gridColor: 'rgba(255, 255, 255, 0.1)',
        tickColor: 'rgba(255, 255, 255, 0.5)',
    },
    light: {
        backgroundColor: '#f5f7fa',
        textColor: '#2d3748',
        gridColor: 'rgba(0, 0, 0, 0.1)',
        tickColor: 'rgba(0, 0, 0, 0.5)',
    }
};

// å½“å‰ä¸»é¢˜
let currentTheme = 'dark';

/**
 * é¡µé¢åˆå§‹åŒ–
 */
document.addEventListener('DOMContentLoaded', () => {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // ç»‘å®šåˆ·æ–°æ•°æ®æŒ‰é’®äº‹ä»¶
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshDataBtn = document.getElementById('refreshData');
    
    // å°è¯•ç»‘å®šåˆ·æ–°æŒ‰é’®ï¼Œæ”¯æŒä¸¤ç§å¯èƒ½çš„ID
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
            fetchSystemData(true);
        });
        console.log('æˆåŠŸç»‘å®šrefreshBtnæŒ‰é’®äº‹ä»¶');
    } else if (refreshDataBtn) {
        refreshDataBtn.addEventListener('click', () => {
            console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
            fetchSystemData(true);
        });
        console.log('æˆåŠŸç»‘å®šrefreshDataæŒ‰é’®äº‹ä»¶');
    } else {
        console.warn('æœªæ‰¾åˆ°åˆ·æ–°æŒ‰é’®å…ƒç´ ');
    }
    
    // ç»‘å®šå¯åŠ¨/åœæ­¢æŒ‰é’®äº‹ä»¶
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    if (startBtn) {
        startBtn.addEventListener('click', startBot);
    } else {
        console.warn('æœªæ‰¾åˆ°å¯åŠ¨æŒ‰é’®å…ƒç´ ');
    }
    
    if (stopBtn) {
        stopBtn.addEventListener('click', stopBot);
    } else {
        console.warn('æœªæ‰¾åˆ°åœæ­¢æŒ‰é’®å…ƒç´ ');
    }
    
    // ç»‘å®šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', toggleTheme);
    } else {
        console.warn('æœªæ‰¾åˆ°ä¸»é¢˜åˆ‡æ¢æŒ‰é’®å…ƒç´ ');
    }
    
    // ç»‘å®šæ¸…é™¤æ—¥å¿—æŒ‰é’®
    const clearLogsBtn = document.getElementById('clearLogsBtn');
    if (clearLogsBtn) {
        clearLogsBtn.addEventListener('click', () => {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                logContainer.innerHTML = '';
                addLog('æ—¥å¿—å·²æ¸…é™¤', 'success');
            }
        });
        console.log('æˆåŠŸç»‘å®šclearLogsBtnæŒ‰é’®äº‹ä»¶');
    } else {
        console.warn('æœªæ‰¾åˆ°æ¸…é™¤æ—¥å¿—æŒ‰é’®å…ƒç´ ');
    }
    
    // ç»‘å®šæ—¶é—´å‘¨æœŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    bindChartPeriodButtons();
    
    // å…ˆåˆå§‹åŒ–å›¾è¡¨ï¼Œç¡®ä¿å›¾è¡¨å‡†å¤‡å°±ç»ªåå†åŠ è½½æ•°æ®
    console.log('å¼€å§‹åˆå§‹åŒ–å›¾è¡¨ç»„ä»¶...');
    initCharts();
    console.log('å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    
    // å›¾è¡¨å‡†å¤‡å°±ç»ªååŠ è½½åˆå§‹æ•°æ®
    setTimeout(() => {
        console.log('å›¾è¡¨å·²åˆå§‹åŒ–ï¼Œå¼€å§‹åŠ è½½æ•°æ®...');
        // åŠ è½½åˆå§‹æ•°æ®
        fetchSystemData(true);
        fetchRecentTrades();
        fetchRecentTokens();
        
        // è®¾ç½®å®šæ—¶åˆ·æ–°
        setInterval(() => {
            fetchSystemData(false);
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        
        setInterval(() => {
            fetchRecentTrades();
        }, 60000); // 1åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡äº¤æ˜“è®°å½•
        
        setInterval(() => {
            fetchRecentTokens();
        }, 120000); // 2åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ä»£å¸æ•°æ®
    }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿å›¾è¡¨å·²å®Œå…¨åˆå§‹åŒ–
});

/**
 * ç»‘å®šå›¾è¡¨æ—¶é—´å‘¨æœŸæŒ‰é’®
 */
function bindChartPeriodButtons() {
    // ä»£å¸å‘ç°è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸæŒ‰é’®
    const tokenChartContainer = document.getElementById('tokenDiscoveryChart');
    if (tokenChartContainer) {
        const tokenPeriodBtns = tokenChartContainer.parentElement.querySelectorAll('.btn-outline');
        
        if (tokenPeriodBtns && tokenPeriodBtns.length > 0) {
            tokenPeriodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    tokenPeriodBtns.forEach(b => b.classList.remove('active'));
                    // ä¸ºå½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeç±»
                    this.classList.add('active');
                    
                    // è·å–æ—¶é—´å‘¨æœŸ
                    const period = this.textContent.trim();
                    console.log(`åˆ‡æ¢ä»£å¸å‘ç°è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸä¸º: ${period}`);
                    
                    // æ ¹æ®æ—¶é—´å‘¨æœŸæ›´æ–°å›¾è¡¨æ•°æ®
                    fetchTokenDiscoveryTrend(period);
                });
            });
            console.log('ä»£å¸å‘ç°è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸæŒ‰é’®ç»‘å®šæˆåŠŸ');
        }
    }
    
    // åˆ©æ¶¦è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸæŒ‰é’®
    const profitChartContainer = document.getElementById('profitTrendChart');
    if (profitChartContainer) {
        const profitPeriodBtns = profitChartContainer.parentElement.querySelectorAll('.btn-outline');
        
        if (profitPeriodBtns && profitPeriodBtns.length > 0) {
            profitPeriodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    profitPeriodBtns.forEach(b => b.classList.remove('active'));
                    // ä¸ºå½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeç±»
                    this.classList.add('active');
                    
                    // è·å–æ—¶é—´å‘¨æœŸ
                    const period = this.textContent.trim();
                    console.log(`åˆ‡æ¢åˆ©æ¶¦è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸä¸º: ${period}`);
                    
                    // æ ¹æ®æ—¶é—´å‘¨æœŸæ›´æ–°å›¾è¡¨æ•°æ®
                    fetchProfitTrend(period);
                });
            });
            console.log('åˆ©æ¶¦è¶‹åŠ¿å›¾æ—¶é—´å‘¨æœŸæŒ‰é’®ç»‘å®šæˆåŠŸ');
        }
    }
}

/**
 * è·å–ä»£å¸å‘ç°è¶‹åŠ¿æ•°æ®
 * @param {string} period - æ—¶é—´å‘¨æœŸ (12å°æ—¶, 24å°æ—¶, 7å¤©)
 */
async function fetchTokenDiscoveryTrend(period) {
    try {
        addLog(`æ­£åœ¨è·å–${period}ä»£å¸å‘ç°è¶‹åŠ¿...`, 'info');
        
        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–ä¸åŒæ—¶é—´å‘¨æœŸçš„æ•°æ®
        // å…ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        let mockData = [];
        
        switch(period) {
            case '12å°æ—¶':
                mockData = Array(12).fill(0).map((_, i) => ({
                    hour: String(i).padStart(2, '0'),
                    count: Math.floor(Math.random() * 15)
                }));
                break;
            case '24å°æ—¶':
                mockData = Array(24).fill(0).map((_, i) => ({
                    hour: String(i).padStart(2, '0'),
                    count: Math.floor(Math.random() * 20)
                }));
                break;
            case '7å¤©':
                const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                mockData = Array(7).fill(0).map((_, i) => ({
                    hour: days[i],
                    count: Math.floor(Math.random() * 50)
                }));
                break;
            default:
                mockData = Array(12).fill(0).map((_, i) => ({
                    hour: String(i).padStart(2, '0'),
                    count: Math.floor(Math.random() * 15)
                }));
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        if (charts.tokenDiscoveryChart) {
            const labels = mockData.map(item => `${item.hour}`);
            const data = mockData.map(item => item.count);
            
            charts.tokenDiscoveryChart.data.labels = labels;
            charts.tokenDiscoveryChart.data.datasets[0].data = data;
            charts.tokenDiscoveryChart.update();
            console.log(`ä»£å¸å‘ç°è¶‹åŠ¿å›¾(${period})æ›´æ–°æˆåŠŸ`);
        }
        
        addLog(`${period}ä»£å¸å‘ç°è¶‹åŠ¿åŠ è½½å®Œæˆ`, 'info');
    } catch (error) {
        console.error(`è·å–${period}ä»£å¸å‘ç°è¶‹åŠ¿å¤±è´¥:`, error);
        addLog(`è·å–${period}ä»£å¸å‘ç°è¶‹åŠ¿å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * è·å–åˆ©æ¶¦è¶‹åŠ¿æ•°æ®
 * @param {string} period - æ—¶é—´å‘¨æœŸ (24å°æ—¶, 7å¤©, 30å¤©)
 */
async function fetchProfitTrend(period) {
    try {
        addLog(`æ­£åœ¨è·å–${period}åˆ©æ¶¦è¶‹åŠ¿...`, 'info');
        
        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–ä¸åŒæ—¶é—´å‘¨æœŸçš„æ•°æ®
        // å…ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        let mockData = [];
        
        switch(period) {
            case '24å°æ—¶':
                mockData = Array(24).fill(0).map((_, i) => {
                    return {
                        date: `${String(i).padStart(2, '0')}:00`,
                        value: Math.random() * 30
                    };
                });
                break;
            case '7å¤©':
                const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                mockData = Array(7).fill(0).map((_, i) => {
                    return {
                        date: days[i],
                        value: Math.random() * 40
                    };
                });
                break;
            case '30å¤©':
                mockData = Array(30).fill(0).map((_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (29 - i));
                    return {
                        date: `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`,
                        value: Math.random() * 50
                    };
                });
                break;
            default:
                const defaultDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                mockData = Array(7).fill(0).map((_, i) => {
                    return {
                        date: defaultDays[i],
                        value: Math.random() * 40
                    };
                });
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        if (charts.profitTrendChart) {
            const labels = mockData.map(item => item.date);
            const data = mockData.map(item => item.value);
            
            charts.profitTrendChart.data.labels = labels;
            charts.profitTrendChart.data.datasets[0].data = data;
            charts.profitTrendChart.update();
            console.log(`åˆ©æ¶¦è¶‹åŠ¿å›¾(${period})æ›´æ–°æˆåŠŸ`);
        }
        
        addLog(`${period}åˆ©æ¶¦è¶‹åŠ¿åŠ è½½å®Œæˆ`, 'info');
    } catch (error) {
        console.error(`è·å–${period}åˆ©æ¶¦è¶‹åŠ¿å¤±è´¥:`, error);
        addLog(`è·å–${period}åˆ©æ¶¦è¶‹åŠ¿å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * åˆå§‹åŒ–å›¾è¡¨
 */
function initCharts() {
    try {
        // ç¡®ä¿Chart.jsåŠ è½½å®Œæˆ
        if (typeof Chart === 'undefined') {
            console.error('Chart.jsæœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–å›¾è¡¨');
            return;
        }

        // åˆå§‹åŒ–ä»£å¸å‘ç°è¶‹åŠ¿å›¾
        const tokenChartContainer = document.getElementById('tokenDiscoveryChart');
        if (!tokenChartContainer) {
            console.error('æ‰¾ä¸åˆ°tokenDiscoveryChartå®¹å™¨å…ƒç´ ');
            return;
        }

        // æ‰¾åˆ°å®¹å™¨å†…çš„canvaså…ƒç´ 
        const tokenCanvas = tokenChartContainer.querySelector('canvas');
        if (!tokenCanvas) {
            console.error('åœ¨tokenDiscoveryChartå®¹å™¨ä¸­æ‰¾ä¸åˆ°canvaså…ƒç´ ');
            return;
        }

        // è·å–canvasçš„2dä¸Šä¸‹æ–‡
        const tokenChartCtx = tokenCanvas.getContext('2d');
        if (!tokenChartCtx) {
            console.error('æ— æ³•è·å–tokenDiscoveryChartçš„2dä¸Šä¸‹æ–‡');
            return;
        }

        console.log('åˆå§‹åŒ–ä»£å¸å‘ç°è¶‹åŠ¿å›¾...');
        try {
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆé”€æ¯æ—§çš„å®ä¾‹
            if (charts.tokenDiscoveryChart instanceof Chart) {
                charts.tokenDiscoveryChart.destroy();
            }

            charts.tokenDiscoveryChart = new Chart(tokenChartCtx, {
                type: 'bar',
                data: {
                    labels: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11'],
                    datasets: [{
                        label: 'å‘ç°ä»£å¸æ•°',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#bd4dff',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            console.log('ä»£å¸å‘ç°è¶‹åŠ¿å›¾åˆå§‹åŒ–æˆåŠŸ');
        } catch (chartError) {
            console.error('ä»£å¸å‘ç°è¶‹åŠ¿å›¾åˆå§‹åŒ–å¤±è´¥:', chartError);
        }
        
        // åˆå§‹åŒ–åˆ©æ¶¦è¶‹åŠ¿å›¾
        const profitChartContainer = document.getElementById('profitTrendChart');
        if (!profitChartContainer) {
            console.error('æ‰¾ä¸åˆ°profitTrendChartå®¹å™¨å…ƒç´ ');
            return;
        }

        // æ‰¾åˆ°å®¹å™¨å†…çš„canvaså…ƒç´ 
        const profitCanvas = profitChartContainer.querySelector('canvas');
        if (!profitCanvas) {
            console.error('åœ¨profitTrendChartå®¹å™¨ä¸­æ‰¾ä¸åˆ°canvaså…ƒç´ ');
            return;
        }

        // è·å–canvasçš„2dä¸Šä¸‹æ–‡
        const profitChartCtx = profitCanvas.getContext('2d');
        if (!profitChartCtx) {
            console.error('æ— æ³•è·å–profitTrendChartçš„2dä¸Šä¸‹æ–‡');
            return;
        }

        console.log('åˆå§‹åŒ–åˆ©æ¶¦è¶‹åŠ¿å›¾...');
        try {
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆé”€æ¯æ—§çš„å®ä¾‹
            if (charts.profitTrendChart instanceof Chart) {
                charts.profitTrendChart.destroy();
            }

            charts.profitTrendChart = new Chart(profitChartCtx, {
                type: 'bar',
                data: {
                    labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
                    datasets: [{
                        label: 'æ”¶ç›Š (SOL)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#36a2eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            console.log('åˆ©æ¶¦è¶‹åŠ¿å›¾åˆå§‹åŒ–æˆåŠŸ');
        } catch (chartError) {
            console.error('åˆ©æ¶¦è¶‹åŠ¿å›¾åˆå§‹åŒ–å¤±è´¥:', chartError);
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–å›¾è¡¨å¤±è´¥:', error);
        addLog(`åˆå§‹åŒ–å›¾è¡¨å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * è·å–ç³»ç»Ÿæ•°æ®
 * @param {boolean} showLoading - æ˜¯å¦æ˜¾ç¤ºåŠ è½½æç¤º
 */
async function fetchSystemData(showLoading = false) {
    if (showLoading) {
        addLog('æ­£åœ¨åˆ·æ–°ç³»ç»Ÿæ•°æ®...', 'info');
    }
    
    try {
        console.log('å¼€å§‹è·å–ç³»ç»Ÿæ•°æ®...');
        // å°è¯•ä»APIè·å–æ•°æ®
        try {
            const apiUrl = window.ENV ? window.ENV.API_URL : 'https://sol.deeptv.tv/api';
            const response = await fetch(`${apiUrl}/system/status`, { timeout: 3000 });
            const responseData = await response.json();
            
            if (!responseData.success) {
                throw new Error(responseData.error || 'è·å–æ•°æ®å¤±è´¥');
            }
            
            // æ›´æ–°ç³»ç»Ÿæ•°æ® - æ³¨æ„dataåµŒå¥—å±‚æ¬¡
            const data = responseData.data;
            console.log('APIæ•°æ®è·å–æˆåŠŸ:', data);
            
            // æ ‡è®°ä¸ºçœŸå®æ•°æ®
            data.isRealData = true;
            
            // æ›´æ–°ç³»ç»Ÿæ•°æ®
            updateDashboard(data);
            
            if (showLoading) {
                addLog('ç³»ç»Ÿæ•°æ®åˆ·æ–°å®Œæˆ', 'info');
            }
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            updateLastUpdated();
        } catch (apiError) {
            console.warn('APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', apiError);
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const mockData = generateMockSystemData();
            // æ ‡è®°ä¸ºæ¨¡æ‹Ÿæ•°æ®
            mockData.isRealData = false;
            updateDashboard(mockData);
            
            if (showLoading) {
                addLog('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ›´æ–°ç•Œé¢', 'warning');
            }
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            updateLastUpdated();
        }
    } catch (error) {
        console.error('è·å–ç³»ç»Ÿæ•°æ®å¤±è´¥:', error);
        addLog(`è·å–ç³»ç»Ÿæ•°æ®å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * è·å–æœ€è¿‘äº¤æ˜“è®°å½•
 */
async function fetchRecentTrades() {
    try {
        const apiUrl = window.ENV ? window.ENV.API_URL : 'https://sol.deeptv.tv/api';
        const response = await fetch(`${apiUrl}/transactions`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'è·å–äº¤æ˜“æ•°æ®å¤±è´¥');
        }
        
        // æ›´æ–°äº¤æ˜“è¡¨æ ¼
        updateTradesTable(data.data.slice(0, 5)); // åªæ˜¾ç¤ºå‰5æ¡
    } catch (error) {
        console.error('è·å–äº¤æ˜“è®°å½•å¤±è´¥:', error);
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        updateTradesTable(generateMockTrades());
    }
}

/**
 * è·å–æœ€è¿‘å‘ç°çš„ä»£å¸
 */
async function fetchRecentTokens() {
    try {
        const apiUrl = window.ENV ? window.ENV.API_URL : 'https://sol.deeptv.tv/api';
        const response = await fetch(`${apiUrl}/tokens`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'è·å–ä»£å¸æ•°æ®å¤±è´¥');
        }
        
        // æ›´æ–°ä»£å¸è¡¨æ ¼
        updateTokensTable(data.data.slice(0, 5)); // åªæ˜¾ç¤ºå‰5æ¡
    } catch (error) {
        console.error('è·å–ä»£å¸æ•°æ®å¤±è´¥:', error);
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        updateTokensTable(generateMockTokens());
    }
}

/**
 * æ›´æ–°ä»ªè¡¨ç›˜æ•°æ®
 * @param {Object} data - ç³»ç»Ÿæ•°æ®
 */
function updateDashboard(data) {
    // æ›´æ–°ç³»ç»Ÿæ•°æ®
    Object.assign(systemData, data);
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ¨¡æ‹Ÿæ•°æ®
    const mockPrefix = systemData.isRealData === false ? 'ã€æ¨¡æ‹Ÿã€‘' : '';
    
    // æ›´æ–°çŠ¶æ€æŒ‡æ ‡
    if (elements.cpuUsage) {
        elements.cpuUsage.textContent = `${mockPrefix}${systemData.cpu.toFixed(1)}%`;
    }
    if (elements.cpuBar) {
        elements.cpuBar.style.width = `${systemData.cpu}%`;
    }
    
    if (elements.memoryUsage) {
        elements.memoryUsage.textContent = `${mockPrefix}${systemData.memory.toFixed(1)}%`;
    }
    if (elements.memoryBar) {
        elements.memoryBar.style.width = `${systemData.memory}%`;
    }
    
    // æ›´æ–°è¿è¡Œæ—¶é—´
    if (elements.uptime) {
        elements.uptime.textContent = `${mockPrefix}${formatUptime(systemData.uptime)}`;
    }
    
    // æ›´æ–°æ”¶ç›Š
    if (elements.totalProfit) {
        elements.totalProfit.textContent = `${mockPrefix}${systemData.profit.toFixed(4)} SOL`;
    }
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    if (elements.monitoredTokens) {
        elements.monitoredTokens.textContent = `${mockPrefix}${systemData.monitoredTokens}`;
    }
    if (elements.activePools) {
        elements.activePools.textContent = `${mockPrefix}${systemData.activePools}`;
    }
    if (elements.executedTrades) {
        elements.executedTrades.textContent = `${mockPrefix}${systemData.executedTrades}`;
    }
    
    // æ›´æ–°ç³»ç»ŸçŠ¶æ€
    updateSystemStatus(systemData.status);
    
    // æ›´æ–°å›¾è¡¨æ•°æ®
    updateCharts();
}

/**
 * æ›´æ–°å›¾è¡¨æ•°æ®
 */
function updateCharts() {
    console.log('å¼€å§‹æ›´æ–°å›¾è¡¨æ•°æ®', systemData);
    
    try {
        // æ›´æ–°ä»£å¸å‘ç°è¶‹åŠ¿å›¾
        if (charts.tokenDiscoveryChart) {
            console.log('æ›´æ–°ä»£å¸å‘ç°è¶‹åŠ¿å›¾', systemData.tokenDiscoveryTrend);
            
            // ç¡®ä¿æœ‰æ•°æ®å¯ç”¨
            if (systemData.tokenDiscoveryTrend && Array.isArray(systemData.tokenDiscoveryTrend)) {
                const labels = systemData.tokenDiscoveryTrend.map(item => `${item.hour || '00'}:00`);
                const data = systemData.tokenDiscoveryTrend.map(item => item.count || 0);
                
                console.log('å¤„ç†åçš„æ ‡ç­¾å’Œæ•°æ®:', labels, data);
                
                // å®‰å…¨åœ°æ›´æ–°å›¾è¡¨æ•°æ®
                try {
                    charts.tokenDiscoveryChart.data.labels = labels;
                    charts.tokenDiscoveryChart.data.datasets[0].data = data;
                    charts.tokenDiscoveryChart.update();
                    console.log('ä»£å¸å‘ç°è¶‹åŠ¿å›¾æ›´æ–°æˆåŠŸ');
                } catch (updateError) {
                    console.error('ä»£å¸å‘ç°è¶‹åŠ¿å›¾æ›´æ–°å¤±è´¥:', updateError);
                }
            } else {
                console.warn('ç¼ºå°‘ä»£å¸å‘ç°è¶‹åŠ¿æ•°æ®');
            }
        } else {
            console.warn('ä»£å¸å‘ç°è¶‹åŠ¿å›¾å°šæœªåˆå§‹åŒ–');
        }
        
        // æ›´æ–°åˆ©æ¶¦è¶‹åŠ¿å›¾
        if (charts.profitTrendChart) {
            console.log('æ›´æ–°åˆ©æ¶¦è¶‹åŠ¿å›¾', systemData.profitTrend);
            
            // ç¡®ä¿æœ‰æ•°æ®å¯ç”¨
            if (systemData.profitTrend && Array.isArray(systemData.profitTrend)) {
                const labels = systemData.profitTrend.map(item => item.date || '');
                const data = systemData.profitTrend.map(item => item.value || 0);
                
                console.log('å¤„ç†åçš„æ ‡ç­¾å’Œæ•°æ®:', labels, data);
                
                // å®‰å…¨åœ°æ›´æ–°å›¾è¡¨æ•°æ®
                try {
                    charts.profitTrendChart.data.labels = labels;
                    charts.profitTrendChart.data.datasets[0].data = data;
                    charts.profitTrendChart.update();
                    console.log('åˆ©æ¶¦è¶‹åŠ¿å›¾æ›´æ–°æˆåŠŸ');
                } catch (updateError) {
                    console.error('åˆ©æ¶¦è¶‹åŠ¿å›¾æ›´æ–°å¤±è´¥:', updateError);
                }
            } else {
                console.warn('ç¼ºå°‘åˆ©æ¶¦è¶‹åŠ¿æ•°æ®');
            }
        } else {
            console.warn('åˆ©æ¶¦è¶‹åŠ¿å›¾å°šæœªåˆå§‹åŒ–');
        }
    } catch (error) {
        console.error('æ›´æ–°å›¾è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
    }
}

/**
 * æ›´æ–°äº¤æ˜“è¡¨æ ¼
 * @param {Array} trades - äº¤æ˜“æ•°æ®
 */
function updateTradesTable(trades) {
    if (!elements.tradesTableBody) return;
    
    elements.tradesTableBody.innerHTML = '';
    
    if (!trades || trades.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="text-center">æš‚æ— äº¤æ˜“è®°å½•</td>';
        elements.tradesTableBody.appendChild(row);
        return;
    }
    
    for (const trade of trades) {
        const row = document.createElement('tr');
        
        // è®¾ç½®çŠ¶æ€ç±»å
        let statusClass = '';
        switch (trade.status) {
            case 'success':
                statusClass = 'text-success';
                break;
            case 'pending':
                statusClass = 'text-warning';
                break;
            case 'failed':
                statusClass = 'text-error';
                break;
            default:
                statusClass = '';
        }
        
        row.innerHTML = `
            <td>${trade.id}</td>
            <td>${trade.pair}</td>
            <td>${trade.amount}</td>
            <td>${trade.profit}</td>
            <td>${trade.time}</td>
            <td class="${statusClass}">${formatStatus(trade.status)}</td>
        `;
        
        elements.tradesTableBody.appendChild(row);
    }
}

/**
 * æ›´æ–°ä»£å¸è¡¨æ ¼
 * @param {Array} tokens - ä»£å¸æ•°æ®
 */
function updateTokensTable(tokens) {
    if (!elements.tokensTableBody) return;
    
    elements.tokensTableBody.innerHTML = '';
    
    if (!tokens || tokens.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" class="text-center">æš‚æ— ä»£å¸æ•°æ®</td>';
        elements.tokensTableBody.appendChild(row);
        return;
    }
    
    for (const token of tokens) {
        const row = document.createElement('tr');
        
        // è®¾ç½®é£é™©ç­‰çº§ç±»å
        let riskClass = '';
        if (token.riskScore < 3) {
            riskClass = 'text-success';
        } else if (token.riskScore < 7) {
            riskClass = 'text-warning';
        } else {
            riskClass = 'text-error';
        }
        
        row.innerHTML = `
            <td>${token.name}</td>
            <td>${formatAddress(token.address)}</td>
            <td>${formatDateTime(token.discoveredAt)}</td>
            <td>$${formatNumber(token.liquidity)}</td>
            <td class="${riskClass}">${token.riskScore.toFixed(1)}</td>
        `;
        
        elements.tokensTableBody.appendChild(row);
    }
}

/**
 * æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
 * @param {string} status - ç³»ç»ŸçŠ¶æ€
 */
function updateSystemStatus(status) {
    if (!elements.statusIndicator || !elements.statusText) return;
    
    if (status === 'running') {
        elements.statusIndicator.classList.remove('offline');
        elements.statusIndicator.classList.add('online');
        elements.statusText.textContent = 'çŠ¶æ€: è¿è¡Œä¸­';
        
        if (elements.startBtn) elements.startBtn.disabled = true;
        if (elements.stopBtn) elements.stopBtn.disabled = false;
    } else {
        elements.statusIndicator.classList.remove('online');
        elements.statusIndicator.classList.add('offline');
        elements.statusText.textContent = 'çŠ¶æ€: å·²åœæ­¢';
        
        if (elements.startBtn) elements.startBtn.disabled = false;
        if (elements.stopBtn) elements.stopBtn.disabled = true;
    }
}

/**
 * æ·»åŠ æ—¥å¿—ä¿¡æ¯åˆ°æ—¥å¿—å®¹å™¨
 * @param {string} message - æ—¥å¿—æ¶ˆæ¯å†…å®¹
 * @param {string} type - æ—¥å¿—ç±»å‹ (info, warning, error, success)
 */
function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    if (!logContainer) return;
    
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    // æ ¹æ®æ—¥å¿—ç±»å‹è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
    let color, icon;
    switch (type) {
        case 'info':
            color = 'blue';
            icon = 'â„¹ï¸';
            break;
        case 'warning':
            color = 'orange';
            icon = 'âš ï¸';
            break;
        case 'error':
            color = 'red';
            icon = 'âŒ';
            break;
        case 'success':
            color = 'green';
            icon = 'âœ…';
            break;
        default:
            color = 'gray';
            icon = 'ğŸ“';
    }
    
    // åˆ›å»ºæ—¥å¿—å…ƒç´  - Markdownæ ¼å¼çš„ä»£ç å—
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    // ä½¿ç”¨Markdownæ ¼å¼çš„ä»£ç å—å±•ç¤ºæ—¥å¿—
    logEntry.innerHTML = `
        <div class="markdown-log">
            <pre><code><span style="color: ${color};">${icon} ${timeString} - ${message}</span></code></pre>
        </div>
    `;
    
    // å°†æ—¥å¿—æ·»åŠ åˆ°å®¹å™¨é¡¶éƒ¨
    logContainer.insertBefore(logEntry, logContainer.firstChild);
    
    // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œä¿ç•™æœ€æ–°çš„50æ¡
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

/**
 * æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
 */
function updateLastUpdated() {
    if (!elements.lastUpdated) return;
    
    const now = new Date();
    elements.lastUpdated.textContent = now.toLocaleString();
}

/**
 * å¯åŠ¨MEVæœºå™¨äºº
 */
async function startBot() {
    try {
        addLog('æ­£åœ¨å¯åŠ¨MEVæœºå™¨äºº...', 'info');
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨
        updateSystemStatus('running');
        addLog('MEVæœºå™¨äººå·²æˆåŠŸå¯åŠ¨', 'info');
        
        // åˆ·æ–°æ•°æ®
        setTimeout(() => {
            fetchSystemData(true);
        }, 1000);
    } catch (error) {
        console.error('å¯åŠ¨MEVæœºå™¨äººå¤±è´¥:', error);
        addLog(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * åœæ­¢MEVæœºå™¨äºº
 */
async function stopBot() {
    try {
        addLog('æ­£åœ¨åœæ­¢MEVæœºå™¨äºº...', 'info');
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨
        updateSystemStatus('stopped');
        addLog('MEVæœºå™¨äººå·²åœæ­¢', 'info');
        
        // åˆ·æ–°æ•°æ®
        setTimeout(() => {
            fetchSystemData(true);
        }, 1000);
    } catch (error) {
        console.error('åœæ­¢MEVæœºå™¨äººå¤±è´¥:', error);
        addLog(`åœæ­¢å¤±è´¥: ${error.message}`, 'error');
    }
}

/**
 * åˆ‡æ¢ä¸»é¢˜
 */
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    const selectedTheme = themes[currentTheme];
    
    // å°†æ–°ä¸»é¢˜åº”ç”¨åˆ°å›¾è¡¨
    if (charts.tokenDiscoveryChart) {
        charts.tokenDiscoveryChart.options.scales.x.grid.color = selectedTheme.gridColor;
        charts.tokenDiscoveryChart.options.scales.y.grid.color = selectedTheme.gridColor;
        charts.tokenDiscoveryChart.options.scales.x.ticks.color = selectedTheme.tickColor;
        charts.tokenDiscoveryChart.options.scales.y.ticks.color = selectedTheme.tickColor;
        charts.tokenDiscoveryChart.update();
    }
    
    if (charts.profitTrendChart) {
        charts.profitTrendChart.options.scales.x.grid.color = selectedTheme.gridColor;
        charts.profitTrendChart.options.scales.y.grid.color = selectedTheme.gridColor;
        charts.profitTrendChart.options.scales.x.ticks.color = selectedTheme.tickColor;
        charts.profitTrendChart.options.scales.y.ticks.color = selectedTheme.tickColor;
        charts.profitTrendChart.update();
    }
    
    // åˆ‡æ¢æ–‡æ¡£ä¸»é¢˜
    document.body.classList.toggle('light-theme');
    document.body.classList.toggle('dark-theme');
}

/**
 * æ ¼å¼åŒ–åœ°å€æ˜¾ç¤º
 * @param {string} address - å®Œæ•´åœ°å€
 * @param {number} prefixLength - å‰ç¼€é•¿åº¦
 * @param {number} suffixLength - åç¼€é•¿åº¦
 * @returns {string} æ ¼å¼åŒ–åçš„åœ°å€
 */
function formatAddress(address, prefixLength = 6, suffixLength = 4) {
    if (!address || address.length <= prefixLength + suffixLength) return address;
    return `${address.substring(0, prefixLength)}...${address.substring(address.length - suffixLength)}`;
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
 * @param {string} dateStr - ISOæ—¥æœŸå­—ç¬¦ä¸²
 * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸæ—¶é—´
 */
function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString();
}

/**
 * æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
 * @param {number} seconds - è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
 * @returns {string} æ ¼å¼åŒ–åçš„è¿è¡Œæ—¶é—´
 */
function formatUptime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${secs}ç§’`;
}

/**
 * æ ¼å¼åŒ–çŠ¶æ€æ–‡æœ¬
 * @param {string} status - çŠ¶æ€å€¼
 * @returns {string} æ ¼å¼åŒ–åçš„çŠ¶æ€æ–‡æœ¬
 */
function formatStatus(status) {
    switch (status) {
        case 'success':
            return 'æˆåŠŸ';
        case 'pending':
            return 'å¤„ç†ä¸­';
        case 'failed':
            return 'å¤±è´¥';
        default:
            return status;
    }
}

/**
 * æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒä½åˆ†éš”ç¬¦ï¼‰
 * @param {number} number - éœ€è¦æ ¼å¼åŒ–çš„æ•°å­—
 * @param {number} decimals - å°æ•°ä½æ•°
 * @returns {string} æ ¼å¼åŒ–åçš„æ•°å­—
 */
function formatNumber(number, decimals = 0) {
    return number.toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

/**
 * ç”Ÿæˆæ¨¡æ‹Ÿç³»ç»Ÿæ•°æ®
 * @returns {Object} æ¨¡æ‹Ÿç³»ç»Ÿæ•°æ®
 */
function generateMockSystemData() {
    return {
        status: Math.random() > 0.3 ? 'running' : 'stopped',
        cpu: 10 + Math.random() * 60,
        memory: 20 + Math.random() * 50,
        uptime: Math.floor(Math.random() * 86400), // æœ€å¤š1å¤©
        profit: Math.random() * 100,
        monitoredTokens: Math.floor(Math.random() * 200),
        activePools: Math.floor(Math.random() * 100),
        executedTrades: Math.floor(Math.random() * 500),
        tokenDiscoveryTrend: Array(12).fill(0).map((_, i) => ({
            hour: String(i).padStart(2, '0'),
            count: Math.floor(Math.random() * 20)
        })),
        profitTrend: Array(7).fill(0).map((_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (6 - i));
            return {
                date: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`,
                value: Math.random() * 50
            };
        })
    };
}

/**
 * ç”Ÿæˆæ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
 * @returns {Array} æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
 */
function generateMockTrades() {
    const pairs = ['SOL/USDC', 'ETH/SOL', 'JUP/SOL', 'ORCA/SOL', 'BONK/SOL', 'RAY/SOL'];
    const statuses = ['success', 'pending', 'failed'];
    
    return Array(5).fill(0).map((_, i) => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - i * 5);
        
        return {
            id: `Tx${Math.random().toString(16).substring(2, 6)}...${Math.random().toString(16).substring(2, 6)}`,
            pair: pairs[Math.floor(Math.random() * pairs.length)],
            amount: (Math.random() * 1000).toFixed(1),
            profit: (Math.random() * 0.01).toFixed(4),
            time: now.toLocaleTimeString(),
            status: statuses[Math.floor(Math.random() * statuses.length)]
        };
    });
}

/**
 * ç”Ÿæˆæ¨¡æ‹Ÿä»£å¸æ•°æ®
 * @returns {Array} æ¨¡æ‹Ÿä»£å¸æ•°æ®
 */
function generateMockTokens() {
    const names = ['SolGem', 'MoonToken', 'RocketCoin', 'StarDust', 'GalaxyToken'];
    
    return Array(5).fill(0).map((_, i) => {
        const now = new Date();
        now.setHours(now.getHours() - i);
        
        return {
            name: names[i],
            address: `${Math.random().toString(16).substring(2, 34)}`,
            discoveredAt: now.toISOString(),
            liquidity: Math.floor(Math.random() * 1000000),
            riskScore: Math.random() * 10
        };
    });
}

/**
 * ç”Ÿæˆæµ‹è¯•æ—¥å¿—ï¼ˆä¸åŒç±»å‹ï¼‰
 */
function generateTestLogs() {
    // æ¸…ç©ºç°æœ‰æ—¥å¿—
    const logContainer = document.getElementById('logContainer');
    if (logContainer) {
        logContainer.innerHTML = '';
    }
    
    // æ·»åŠ å„ç§ç±»å‹çš„æ—¥å¿—ç¤ºä¾‹
    addLog('è¿™æ˜¯ä¸€æ¡æ™®é€šä¿¡æ¯æ—¥å¿—', 'info');
    addLog('è¿™æ˜¯ä¸€æ¡è­¦å‘Šæ—¥å¿—', 'warning');
    addLog('è¿™æ˜¯ä¸€æ¡é”™è¯¯æ—¥å¿—', 'error');
    addLog('è¿™æ˜¯ä¸€æ¡æˆåŠŸæ—¥å¿—', 'success');
    
    // æ·»åŠ Mockæ•°æ®ç¤ºä¾‹
    addLog('æ­£åœ¨è·å–ç³»ç»Ÿæ•°æ®...', 'info');
    addLog('APIè¯·æ±‚æˆåŠŸï¼Œæ•°æ®å·²æ›´æ–°', 'success');
    addLog('æ­£åœ¨è¿æ¥åˆ°Solanaç½‘ç»œ...', 'info');
    addLog('å‘ç°æ–°ä»£å¸: TOKEN_XYZ', 'info');
    addLog('äº¤æ˜“æ‰§è¡Œå¤±è´¥: Gasä¸è¶³', 'error');
    addLog('ä»·æ ¼æ³¢åŠ¨è­¦å‘Š: SOL/USDT +5.2%', 'warning');
    addLog('äº¤æ˜“æˆåŠŸå®Œæˆï¼Œè·åˆ©: 0.25 SOL', 'success');
    
    // æ·»åŠ Markdownæ ¼å¼æµ‹è¯•
    addLog('**ç³»ç»ŸçŠ¶æ€**: è¿è¡Œä¸­', 'info');
    addLog('`å†…å­˜ä½¿ç”¨ç‡: 65.3%`', 'warning');
    addLog('ä»£ç ç¤ºä¾‹: ```function example() { return true; }```', 'info');
} 